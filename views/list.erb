<% if user_display_name %>
  <div class="user-header">
    <% if user_avatar %>
      <img class="user-header__avatar" src="<%= user_avatar %>" alt="avatar" width="64" height="64">
    <% end %>
    <h2 class="user-header__name"><%= user_display_name %></h2>
    <p class="user-header__info">
      <%= t("header.playlists") %>: <%= stats.total_playlists %>
    </p>
    <p class="user-header__info">
      <%= t("header.owned_playlists") %>: <%= stats.owned_playlists %>
    </p>
    <p class="user-header__info">
      <%= t("header.tracks_in_owned") %>: <%= stats.total_tracks %>
    </p>
    <p class="user-header__info">
      <%= t("header.latest_track") %>:
      <%= stats.latest_track_name %> ‚Äî
      <%= stats.latest_track_artist %>
      (<%= stats.latest_track_date %>)
    </p>
    <form action="/watch/<%= spotify_user_id %>" method="post" id="watch-form">
      <!--<input type="hidden"
         name="spotify_user_id"
         value="<%#= spotify_user_id %>">-->
      <button class="button refresh-button button-circle" type="submit">
        <svg class="refresh-icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a6 6 0 1 1-6 6H4a8 8 0 1 0 13.65-6.65z" />
        </svg>
      </button>
    </form>
  </div>
<% end %>
<%
  all_added = results.flat_map(&:added)
  all_removed = results.flat_map(&:removed)
%>
<% if first_time_per_user %>
  <div class="init-msg">
    <p class="center" ><%= nl2br(t("playlists.first_run")) %></p>
  </div>
<% else %>
  <div class="navigation">
    <% if navigation[:prev_change_id] %>
      <a href="/watch/<%= spotify_user_id %>?change=<%= navigation[:prev_change_id] %>">
        ‚Üê
      </a>
    <% end %>
    <% if navigation[:next_change_id] %>
      <a href="/watch/<%= spotify_user_id %>?change=<%= navigation[:next_change_id] %>">
        ‚Üí
      </a>
    <% end %>
  </div>
  <div class="playlist-grid">
    <% if all_added.any? %>
      <%= erb :'partials/playlist_card', locals: {
      title: t("playlists.added_global"),
      image_url: all_added.first&.album_cover || "/images/cover_added.jpg",
      tracks: all_added
    } %>
    <% end %>
    <% if all_removed.any? %>
      <%= erb :'partials/playlist_card', locals: {
      title: t("playlists.removed_global"),
      image_url: all_removed.first&.album_cover || "/images/cover_removed.jpg",
      tracks: all_removed
    } %>
    <% end %>
    <% results.each do |playlist| %>
      <%= erb :'partials/playlist_card', locals: {
      title: playlist.name,
      image_url: playlist.image_url,
      tracks: playlist.tracks
    } %>
    <% end %>
  </div>
<% end %>
<div class="center" style="margin-top: 30px;">
  <form action="/" method="get">
    <button class="button button_new" type="submit">
      üîç <%= t("header.new_search") %>
    </button>
  </form>
</div>
<script>
  const form = document.getElementById('watch-form');
  const refreshButton = document.querySelector('.refresh-button');

  form.addEventListener('submit', () => {
    refreshButton.classList.add('loading');
  });
</script>
